{% extends 'admin/base.html' %}

{% block title %}会社作成完了{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-check-circle"></i> 会社作成完了
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-success" role="alert">
                        <h5 class="alert-heading">会社「{{ company.name }}」を作成しました</h5>
                        <p class="mb-0">クライアント認証情報が生成されました。下のボタンをクリックして確認してください。</p>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#credentialsModal">
                            <i class="bi bi-key"></i> クライアント認証情報を表示
                        </button>
                        <a href="{% url 'company_list' %}" class="btn btn-secondary">
                            会社一覧に戻る
                        </a>
                    </div>

                    <div class="alert alert-warning mt-3" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>重要:</strong> 認証情報は一度しか表示されません。必ず保存してください。
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="credentialsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-shield-lock"></i> クライアント認証情報
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6><i class="bi bi-exclamation-triangle-fill"></i> 重要なお知らせ</h6>
                    <p class="mb-0">この情報は<strong>一度しか表示されません</strong>。必ず今すぐダウンロードまたはコピーしてください。</p>
                </div>

                <h6 class="mb-3">会社情報</h6>
                <table class="table table-bordered table-sm mb-3">
                    <tbody>
                        <tr><th style="width:30%;">会社ID</th><td>{{ credentials.company_id }}</td></tr>
                        <tr><th>会社名</th><td>{{ credentials.company_name }}</td></tr>
                    </tbody>
                </table>

                <h6 class="mb-3">認証情報</h6>
                <table class="table table-bordered table-sm mb-3">
                    <tbody>
                        <tr>
                            <th style="width:30%;">Client ID</th>
                            <td>
                                <div class="d-flex align-items-center">
                                    <code id="client-id" class="flex-grow-1">{{ credentials.client_id }}</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('client-id')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>Client Secret</th>
                            <td>
                                <div class="d-flex align-items-center">
                                    <code id="client-secret" class="flex-grow-1">{{ credentials.client_secret }}</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('client-secret')">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="confirmClose()">閉じる</button>
                <button type="button" class="btn btn-primary" onclick="downloadCredentials()">
                    <i class="bi bi-download"></i> JSON形式でダウンロード
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let hasDownloaded = false;
function copyToClipboard(id) {
    const el = document.getElementById(id);
    navigator.clipboard.writeText(el.textContent).then(() => {
        const btn = event.target.closest('button');
        const orig = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        btn.classList.replace('btn-outline-secondary', 'btn-success');
        setTimeout(() => { btn.innerHTML = orig; btn.classList.replace('btn-success', 'btn-outline-secondary'); }, 2000);
    });
}
function downloadCredentials() {
    window.location.href = "{% url 'company_credentials_json' company.company_id %}";
    hasDownloaded = true;
    setTimeout(() => {
        bootstrap.Modal.getInstance(document.getElementById('credentialsModal')).hide();
        setTimeout(() => window.location.href = "{% url 'company_list' %}", 500);
    }, 1000);
}
function confirmClose() {
    if (!hasDownloaded && !confirm('認証情報をまだダウンロードしていません。\n本当にモーダルを閉じますか？')) return;
    window.location.href = "{% url 'company_list' %}";
}
document.getElementById('credentialsModal').addEventListener('hide.bs.modal', (e) => {
    if (!hasDownloaded && !confirm('認証情報をまだダウンロードしていません。\n本当にモーダルを閉じますか？')) {
        e.preventDefault();
    } else {
        setTimeout(() => window.location.href = "{% url 'company_list' %}", 100);
    }
});
</script>
{% endblock %}