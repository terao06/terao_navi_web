services:
  navi_admin_db:
    image: navi_admin_db:local
    container_name: navi_admin_db
    build:
      context: .
      dockerfile: ./local_setting/local_db/Dockerfile
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    ports:
      - 33307:3306
    volumes:
      - ./local_data/mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=db_local
      - MYSQL_USER=navi_admin_user
      - MYSQL_PASSWORD=password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - navi_admin_network

  navi_admin_web:
    image: navi_admin_web:local
    container_name: navi_admin_web
    platform: linux/amd64
    build:
      context: .
      dockerfile: ./docker/local/Dockerfile
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        while ! nc -z navi_admin_db 3306; do
          sleep 1
        done &&
        echo 'Database is ready!' &&
        python manage.py runserver 0.0.0.0:8004
      "
    volumes:
      - .:/app
    ports:
      - 8004:8004
    environment:
      - DJANGO_SETTINGS_MODULE=terao_navi_web.settings
      - PYTHONUNBUFFERED=1
    depends_on:
      navi_admin_db:
        condition: service_healthy
    networks:
      - navi_admin_network
    restart: unless-stopped
  
  navi_admin_s3:
    image: minio/minio
    container_name: navi_admin_s3
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./local_data/minio:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    networks:
      - navi_admin_network
    restart: always

  minio_init:
    image: minio/mc
    depends_on:
      - navi_admin_s3
    entrypoint: >
      sh -c "/init/create_bucket.sh"
    volumes:
      - ./local_setting/local_s3:/init
    networks:
      - navi_admin_network
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    ports:
      - "8013:80"
    environment:
      PMA_HOST: navi_admin_db
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: rootpassword
    networks:
      - navi_admin_network
    depends_on:
      navi_admin_db:
        condition: service_healthy
    restart: always

  navi-dynamodb:
    image: amazon/dynamodb-local:latest
    container_name: navi-dynamodb
    ports:
      - "8010:8000"
    command: ["-jar","DynamoDBLocal.jar","-sharedDb"]
    networks: 
      - navi_admin_network

  navi-dynamodb-init:
    image: amazon/aws-cli:latest
    depends_on:
      - navi-dynamodb
    environment:
      - AWS_REGION=ap-northeast-1
      - AWS_ACCESS_KEY_ID=dummy
      - AWS_SECRET_ACCESS_KEY=dummy
      - DDB_ENDPOINT=http://navi-dynamodb:8000
      - DDB_TABLE_PREFIX=
    volumes:
      - ./local_setting/local_dynamo/init:/init:ro
    entrypoint: ["/bin/sh", "-c", "sleep 10 && /init/create_tables.sh"]
    networks:
      - navi_admin_network

  navi-dynamodb-admin:
    image: aaronshaf/dynamodb-admin:latest
    container_name: navi-dynamodb-admin
    ports:
      - "8011:8001"
    environment:
      - DYNAMO_ENDPOINT=http://navi-dynamodb:8000
      - AWS_REGION=ap-northeast-1
      - AWS_ACCESS_KEY_ID=local
      - AWS_SECRET_ACCESS_KEY=local
    depends_on:
      - navi-dynamodb
    networks:
     - navi_admin_network
networks:
  navi_admin_network:
    driver: bridge

volumes:
  minio_data:
